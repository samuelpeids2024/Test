<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Firebase FCM 單頁測試</title>
</head>
<body>
    <h1>FCM 推播測試</h1>
    <p id="status">正在請求權限...</p>
    <p>您的 Token (可用於發送測試通知):</p>
    <textarea id="token-display" style="width:100%; height:100px;" readonly></textarea>
    
    <!-- 引入 Firebase SDK 模組 -->
    <script type="module">

        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-messaging.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-analytics.js";

        // 1. Firebase 配置 (與 SW 檔案中相同)
        const firebaseConfig = {
          apiKey: "AIzaSyDRAx0uqdvxFqbrcxDvCeYt1Z1EUsTFVE8",
          authDomain: "reminderapp-b689e.firebaseapp.com",
          projectId: "reminderapp-b689e",
          storageBucket: "reminderapp-b689e.firebasestorage.app",
          messagingSenderId: "544877244820",
          appId: "1:544877244820:web:bd1e52c24ecf7cfe365f81",
          measurementId: "G-ZY0WC3M9Z1"
        };

        // 2. 初始化 Firebase
        const app = initializeApp(firebaseConfig);
        const messaging = getMessaging(app);

        const statusEl = document.getElementById('status');
        const tokenEl = document.getElementById('token-display');

        // 在 script 加入這個輔助函數
        function logToScreen(message) {
            const el = document.createElement('p');
            el.innerText = `> ${message}`;
            document.body.appendChild(el);
        }

        // Function to play sound using Web Audio API
        function playCustomSound(soundUrl) {
          try {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            fetch(soundUrl)
              .then(response => response.arrayBuffer())
              .then(arrayBuffer => audioContext.decodeAudioData(arrayBuffer))
              .then(audioBuffer => {
                const source = audioContext.createBufferSource();
                source.buffer = audioBuffer;
                source.connect(audioContext.destination);
                source.start();
              })
              .catch(error => console.error("Error playing sound:", error));
          } catch (error) {
            console.error("Web Audio API not supported in this browser:", error);
          }
        }

        // 3. 請求權限並取得 Token
        async function initNotification() {
            try {
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    const registration = await navigator.serviceWorker.register('./firebase-messaging-sw.js');
                    // 注意：'YOUR_PUBLIC_VAPID_KEY' 需從 Firebase 控制台取得
                    const token = await getToken(messaging, { 
                        vapidKey: 'BHc46KlLoJvBJrCCjDERNc7lJr453G6P54pod_NaQjjdy2z_F-0awf1nEN8ncGVS7JzIVsk9lLHfs6TrphZmxgY' ,
                        serviceWorkerRegistration: registration
                    });
                    
                    if (token) {
                        tokenEl.value = token;
                        statusEl.innerText = "權限已允許，Token 取得成功！";
                    } else {
                        statusEl.innerText = "無法取得 Token，請檢查配置。";
                    }
                } else {
                    statusEl.innerText = "使用者拒絕了通知權限。";
                }
            } catch (err) {
                console.error('初始化失敗', err);
                logToScreen("發生錯誤: " + error.message);
                statusEl.innerText = "發生錯誤，請查看控制台。";
            }
        }

        // 4. 監聽前台訊息 (網頁開著時收到通知)
        onMessage(messaging, (payload) => {
            console.log('收到前台訊息: ', payload);
            if (payload.data && payload.data.sound) {
                playCustomSound(payload.data.sound);
                navigator.vibrate(2000);
              }
            alert(`收到通知：${payload.notification.title}\n${payload.notification.body}`);
        });

        initNotification();
    </script>
</body>
</html>
